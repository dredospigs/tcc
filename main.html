<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tela inicial</title>

    <style>
        .invisible{
            width: 100%;
            height: 100px;
            opacity: 0;
            margin: 5px;
        }
        .tbl{
            background-color: #60d16b;
            border-radius: 5px;
            border: #60d16b;
            color: #fff;
            padding: 2px 4px 2px 4px;
            margin-bottom: 10px;
            margin-top: 10px;
            margin-left: 33%;
        }
        .ahoy{
            margin-left: 3px;
            margin-right: 3px;
            font-size: large;
            font-family: "Times New Roman", Helvetica, sans-serif;
        }
    </style>

    <link rel="stylesheet" href="./src/css/main.css">
    <link rel="stylesheet" href="./src/css/navBar.css">
</head>
<body>

    <script type="module" src="https://www.gstatic.com/firebasejs/8.9.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/8.9.1/firebase-database.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/8.9.1/firebase-auth.js"></script>
    <script type="module">
        var firebaseConfig = {
            apiKey: "AIzaSyCL-_CJhMMfImzJa0Y4quouMxzc3VMwl-E",
            authDomain: "db-obras-v2.firebaseapp.com",
            databaseURL: "https://db-obras-v2-default-rtdb.firebaseio.com",
            projectId: "db-obras-v2",
            storageBucket: "db-obras-v2.appspot.com",
            messagingSenderId: "1043440176136",
            appId: "1:1043440176136:web:b2289e1ec2e8c0102655bd"
        };

        firebase.initializeApp(firebaseConfig);
        var database = firebase.database();
    </script>

    
    <div id="obras"></div>
    <div class="invisible"></div>
    <div class="oc">
        <img class="img" id="menu" style="left: 8%" onclick="scrollUp()" src="./src/img/selectedMenu.png">
        <img class="img" id="add" style="left: 42%" src="./src/img/add.png">
        <img class="img" id="profile" style="right: 8%" src="./src/img/profile.png">
    </div>

    <script type="module">
        var token
        var obrasUser
        var kindOfUser

        window.onload = async function show(){
            await getUser(localStorage["auth"]) 
            console.log(obrasUser)

            const obras = obrasUser.split("|")

            var obrasBanco = firebase.database().ref('Obras/');
            var snapshot = await obrasBanco.once('value')

            if(snapshot.exists()){
                snapshot.forEach(function(item) {
                    var data = item.val();
                    var cdg = data.cdg.toString()

                    for(var x = 0; x < obras.length; x++){
                        if(cdg === obras[x]){
                            genAccordion(data)  
                        }
                    }                 
                })
            }
            
            console.log(localStorage["auth"])
            accordion()
        }        

        function genAccordion(data){
            console.log(data)
            let valorTT = 0;
            let porcentagemTT = 0;
            
            try {
                valorTT = precoTT(data.etapas)
                porcentagemTT = porcentagemTTcalc(data.etapas)
            } catch (error) {}
            
            var btnSave, preco, checkboxAble
            if(kindOfUser === 'e'){
                preco = `<div class="precoObra">Preço: ${valorTT}</div>`
                btnSave = `<table class="tbl" id="btn${data.cdg}">
                                <tr>
                                    <td><img src="./src/img/save.png"></td>
                                    <td><span class="ahoy">Salvar</span></td>
                                </tr>
                            </table> ` 
                checkboxAble = ''
            }
            else if(kindOfUser === 'f'){
                preco = ''
                checkboxAble = 'disabled'
                btnSave = ''
            }
            else{
                preco = `<div class="precoObra">Preço: ${valorTT}</div>`
                checkboxAble = 'disabled'
                btnSave = ''
            }

            var newdiv = document.createElement('div'); 
            newdiv.innerHTML = `<div> 
                                    <button class="accordion">
                                        <div class="titleObra">${data.nome}</div>
                                        <div class="dataObra">Data de finalização: ${data.mainDateEnd}</div>
                                        ${preco}
                                        <div class="porcObraN">${Number(porcentagemTT).toFixed(2)}%</div>
                                    </button>
                            <div class="panel"> 
                                <div class="codigo">
                                    Código da obra:
                                    <span style="color:#53b0db;">${data.cdg}</span>
                                </div>
                                <div id="etapas${data.cdg}">                                    
                                </div>  
                                ${btnSave}         
                            </div>
                        </div>`

            document.getElementById('obras').appendChild(newdiv);

            try {
                data.etapas.forEach(etapa => {
                var newEtapa = document.createElement('div');

                var isCompleted = ""
                if(etapa.concluido){
                    isCompleted = "checked"
                }

                newEtapa.innerHTML = `
                                    <div>
                                        <input style="margin-top: 10px;" ${checkboxAble} type="checkbox" ${isCompleted}>
                                            <span style="font-weight:bold">${etapa.nome}</span>
                                        </input>
                                        <div class="descricaoEtapa">${etapa.descricao}</div>
                                        <div class="infoEtapa">
                                            Data: ${etapa.data.dataInicio} - ${etapa.data.dataFinalizacao}<br>
                                            Preço: ${etapa.valor}<br>
                                            Equipe: ${etapa.equipe}
                                        </div>        
                                        <hr>            
                                    </div>`;
                
                document.getElementById(`etapas${data.cdg}`).appendChild(newEtapa);
                });
            } catch (error) {}
            
        }

        function precoTT(etapas){
            let valorTT = 0
            etapas.forEach(etapa => {
                valorTT += Number(etapa.valor)
            });
            return valorTT
        }
    
        function porcentagemTTcalc(etapas){
            var qttdt = 0;
            var qttdc = 0;
            etapas.forEach(etapa => {
                if(etapa.concluido){
                    qttdc++;
                }
                qttdt++
            });

            const porc = (qttdc * 100) / qttdt
            return porc
        }
   
        async function getUser(email){

            var banco = firebase.database().ref('Cadastros/');
            var ss = await banco.once('value')

            if(ss.exists()){
                ss.forEach(function(item) {
                    var data = item.val();

                    Object.keys(data).forEach(function(key) {
                        if(data[key].Email === email){
                            token = data[key].CNPJ || data[key].CPF
                            obrasUser = data[key].obras
                            kindOfUser = data[key].class
                        }
                    });
                })
            }
        }

        document.getElementById('add').addEventListener("click",() => {
            window.location.href = "obra.html"
        })
        document.getElementById('profile').addEventListener("click",() => {
            window.location.href = "perfil.html"
        })
        window.scrollUp = function scrollUp(){
            window.scroll({
                top: 0, 
                left: 0, 
                behavior: 'smooth'
            });
        }
        
   </script>

    <!--accordion script-->
    <script>
        function accordion() {
            var acc = document.getElementsByClassName("accordion");
            var i;
            
            for (i = 0; i < acc.length; i++) {
                acc[i].addEventListener("click", function() {
                    this.classList.toggle("active");
                    var panel = this.nextElementSibling;
                    if (panel.style.maxHeight) {
                        panel.style.maxHeight = null;
                    } else {
                        panel.style.maxHeight = panel.scrollHeight + "px";
                    }
                });
            }
        }
    </script>
</body>
</html>